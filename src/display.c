//
// Low-level routines to control the display
//

#include <ned.h>
#include <intrinsic.h>

const u8 EOL = 0x0d;
const u8 EOF = 0x1a;

//----------------------------------------------------------------------------------------------------------------------

u8* calcTileAddress(u8 x, u8 y)
{
    return (u8 *)(0x4000 + (y * 160) + (x * 2));
}

//----------------------------------------------------------------------------------------------------------------------

void clearArea(u8 x, u8 y, u8 width, u8 height, u8 colour)
{
    u8* p = calcTileAddress(x, y);
    u8 attr = ((colour & 0xf) << 4);
    for (u8 r = 0; r < height; ++r)
    {
        for (u8 c = 0; c < width; ++c)
        {
            *p++ = ' ';
            *p++ = attr;
        }
        p += (80 - width);
    }
}

//----------------------------------------------------------------------------------------------------------------------

void write(u8 x, u8 y, u8 colour, const char* text)
{
    u8* p = calcTileAddress(x, y);
    u8 attr = ((colour & 0xf) << 4);
    while (*text != 0)
    {
        *p++ = *text++;
        *p++ = attr;
    }
}

//----------------------------------------------------------------------------------------------------------------------

void displayRow(u8 sy, u32 pos)
{

}

//----------------------------------------------------------------------------------------------------------------------

void displayTitle()
{
    clearArea(0, 0, 80, 1, 1);
    write(1, 0, 1, "Ed (v1.0)");
}

//----------------------------------------------------------------------------------------------------------------------

void displayStatusBar()
{
    clearArea(0, 31, 80, 1, 1);
    write(1, 31, 1, "Ln 0001  Col 0001");
}

//----------------------------------------------------------------------------------------------------------------------


void displayScreen()
{
    intrinsic_halt();
    clearArea(0, 1, 80, 30, 0);
    displayTitle();
    displayStatusBar();
}

//----------------------------------------------------------------------------------------------------------------------

void displayN(u8 x, u8 y, u32 p, int n, u8 colour)
{
    u8* scr = calcTileAddress(x, y) + (n * 2);
    for (; n >= 0; --n)
    {
        u8 nib = (p & 0xf);
        p >>= 4;
        char c = (nib < 10) ? nib+'0' : nib+'A'-10;
        --scr;
        *scr = (colour << 4);
        --scr;
        *scr = c;
    }
}

//----------------------------------------------------------------------------------------------------------------------

void display32(u8 x, u8 y, u32 p, u8 colour)
{
    displayN(x, y, p, 8, colour);
}

//----------------------------------------------------------------------------------------------------------------------

void display16(u8 x, u8 y, u16 p, u8 colour)
{
    displayN(x, y, p, 4, colour);
}

//----------------------------------------------------------------------------------------------------------------------

void display8(u8 x, u8 y, u8 p, u8 colour)
{
    displayN(x, y, p, 2, colour);
}

